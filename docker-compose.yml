version: '3.8'

services:
  data-ingest:
    build: .
    image: hive-parquet-ingest:latest
    container_name: data-ingest
    restart: unless-stopped
    
    # No command needed - all configuration via environment variables
    # 
    # Alternative configuration methods:
    # 1. Via environment variables (recommended for Docker)
    # 2. Via command line arguments (shown in comments below)
    
    # Example command for file input
    # command: ["--input", "/input/data.txt", "--source", "mydata"]
    # volumes:
    #   - ./input:/input:ro
    
    # Example command for WebSocket AIS Stream input
    # command: [
    #   "--ws-url", "wss://stream.aisstream.io/v0/stream",
    #   "--ws-api-key", "${AIS_API_KEY}",
    #   "--ws-bbox", "37.9,-122.6,37.6,-122.3",
    #   "--source", "ais-sf-bay",
    #   "--s3-bucket", "maritime-data",
    #   "--s3-region", "us-west-2"
    # ]
    
    # Example command for TCP input
    # command: [
    #   "--tcp-host", "153.44.253.27", 
    #   "--tcp-port", "5631",
    #   "--source", "norway-tcp",
    #   "--s3-bucket", "my-data-bucket",
    #   "--s3-region", "us-west-2"
    # ]
    volumes:
      - ./output:/data
    
    # Health check configuration
    healthcheck:
      test: ["/usr/local/bin/hive_parquet_ingest", "--health-check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    
    # Environment variables for application configuration
    environment:
      # Runtime configuration
      - RUST_LOG=info
      
      # Input source configuration (choose one)
      # For file input:
      # - INPUT_FILE=/input/data.txt
      
      # For TCP input:
      # - TCP_HOST=153.44.253.27
      # - TCP_PORT=5631
      
      # For WebSocket AIS input:
      - WS_URL=wss://stream.aisstream.io/v0/stream
      - WS_API_KEY=${AIS_API_KEY}
      - WS_BBOX=37.9,-122.6,37.6,-122.3
      
      # General configuration
      - SOURCE=ais-sf-bay
      - OUT_DIR=/data
      - MAX_ROWS=10000
      - KEEP_LOCAL=false
      
      # S3 configuration
      - S3_BUCKET=maritime-data
      - S3_REGION=us-west-2
      - S3_ENDPOINT=${S3_ENDPOINT:-}
      - S3_ACCESS_KEY=${AWS_ACCESS_KEY_ID:-}
      - S3_SECRET_KEY=${AWS_SECRET_ACCESS_KEY:-}
      
      # Health check can be disabled for normal operation
      - HEALTH_CHECK=false
    
    # Network configuration (if needed)
    # networks:
    #   - data-network

# Uncomment if you need custom networks
# networks:
#   data-network:
#     driver: bridge